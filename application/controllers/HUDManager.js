/**
 * HUDManager is user to manage all HUD design operations
 * Full CRUD cycle for every supported HUD Item
 * @type {*}
 */
visualHUD.Controllers.HUDManager = Backbone.Controller.extend({
    views: [
        'HUDItem',
        'HUDItemForm'
    ],

    models: [
        'HUDItem',
        'ClientSettings'
    ],

    collections: [
        'HUDItemTemplates',
        'HUDItemIconEnums',
        'HUDItems'
    ],

    AUTOSAVE_TIMEOUT: 300000,

    initialize: function(options) {
        this.addListeners({
            'TopBar': {
                'align.action': this.alignItems,
                'toolbar.hud:action': this.groupActions
            },        
            'StageControls': {
                'item.drop': this.dropNewHUDItem
            },
            'Canvas': {
                'drop.move': this.onItemMove
            },
            'LoadWindow': {
                'load': this.loadHUD
            },
            'ImportImageWindow': {
                'import': this.importImage
            },
            'Form': {
                'align.action': this.alignItems,
                'arrange.action': this.arrangeItems
            },
            'HUDItem': {
                'click': this.onHUDItemClick,
                'destroy': this.onHUDItemDestroy
            },
            // Events generated by KeyboardManager Controller
            'keyboard': {
                'select.all': this.selectAllHUDItems,
                'delete': this.deleteSelectedItems,
                'move': this.moveSelectedItems,
                'group': this.groupSelectedItems,
                'clone': this.cloneSelectedItems
            }
        });
    },

    onLaunch: function() {
        var HUDItemsCollection = this.getCollection('HUDItems');
        var clientSettingsModel = this.getModel('ClientSettings');

        clientSettingsModel.on('change', this.updateHUDItemStatus, this);

        HUDItemsCollection.on('add', this.addNewHUDItem, this);
        HUDItemsCollection.on('load', this.loadDraft, this);

        // Load saved HUD Items
        $(window).load(visualHUD.Function.bind(HUDItemsCollection.load, HUDItemsCollection, []));
    },

    /**
     * Event handler triggered by visualHUD.Collections.HUDItems
     * Restore previously saved draft
     */
    loadDraft: function() {
        var canvasView = this.application.getController('Viewport').getView('Canvas'),
            trash = [];
        canvasView.beginUpdate();

        this.getCollection('HUDItems').each(function(record) {
            // using try catch in order to skip damaged/incorrect hud items
            try {
                this.createNewHUDItem(record);
            }
            catch(e) {
                trash.push(record);
                console.warn('Invalid HUD Data!', record.toJSON());
            }
        }, this);
        // remove damaged items from collection
        this.getCollection('HUDItems').remove(trash);
        canvasView.completeUpdate();
    },

    /**
     * Event handler triggered by StageControls View when new HUD Item has been dropped to the canvas
     * @param record
     * @param position
     */
    dropNewHUDItem: function(record, position) {
        var HUDItemModelClass = this.getModelConstructor('HUDItem');
        var HUDItemModel = new HUDItemModelClass();
        var statusText = this.getModel('ClientSettings').getStatusByName(record.get('id'));

        HUDItemModel.setDefaultValues({
            name: record.get('id'),
            itemType: record.get('itemType')
        }).set({
            cssClass: record.get('cssClass'),
            label: record.get('label'),
            coordinates: position
        });

        HUDItemModel.wasDropped = true;

        if(statusText) {
            HUDItemModel.set('text', statusText);
        }

        this.getCollection('HUDItems').add(HUDItemModel);
    },

    /**
     * Create new visualHUD.Views.HUDItem instance based on visualHUD.Models.HUDItem data
     * @param record
     * @return {Object} HUDItem visualHUD.Views.HUDItem instance
     */
    createNewHUDItem: function(record) {
        var HUDItemTemplates = this.getCollection('HUDItemTemplates');
        var canvasView = this.application.getController('Viewport').getView('Canvas');
        var viewportView = this.application.getController('Viewport').getView('Viewport');
        var stageControlsView = viewportView.getStageControlsView();

        var HUDItemViewClass = this.getViewConstructor('HUDItem');
        var formViewClass = this.getViewConstructor('HUDItemForm');
        var HUDItemIconEnums = this.getCollection('HUDItemIconEnums')

        var formView = new formViewClass({
            alias: 'Form',
            model: record,
            renderTo: viewportView.$sidebarArea,
            collections: {
                'HUDItemIconEnums': HUDItemIconEnums
            }
        });

        var HUDItem = new HUDItemViewClass({
            alias: 'HUDItem',
            HUDItemIconEnums: HUDItemIconEnums,
            renderTo: canvasView.$canvas,
            model: record,
            wasDropped: record.wasDropped,
            formView: formView,
            htmlTplRecord: HUDItemTemplates.get(record.get('name'))
        });

        stageControlsView.updateControlsStatus('create', record.get('name'));

        delete record.wasDropped;

        return HUDItem;
    },

    /**
     * Event handler triggered by visualHUD.Collections.HUDItems when new record has been added to the collection
     * @param record
     */
    addNewHUDItem: function(record) {
        var canvasView = this.application.getController('Viewport').getView('Canvas');
        var HUDItem = this.createNewHUDItem(record);
        canvasView.select(HUDItem, false);
    },

    /**
     * Event handler Triggered by visualHUD.Libs.canvasDragInterface
     * @param HUDElementView
     */
    onItemMove: function(HUDElementView) {
        var canvasView = this.application.getController('Viewport').getView('Canvas');

        _.each(canvasView.getSelection(), function(view) {
            view.refreshCoordinates();
        });

        canvasView.disableSelection();
    },

    /**
     * Event handler triggered by visualHUD.Views.HUDItem when item is clicked
     * Used to blur focused form element and select clicked item
     * @param HUDItem
     * @param event
     */
    onHUDItemClick: function(HUDItem, event) {
        var canvasView = this.application.getController('Viewport').getView('Canvas');
        this.application.getController('FocusManager').blur();
        canvasView.select(HUDItem, event.shiftKey || event.ctrlKey);
        canvasView.enableSelection();
    },

    /**
     * Triggered by visualHUD.Views.HUDItem when item is destroyed
     * Used to update StageControls state (for example, enable chat icon)
     * @param record
     */
    onHUDItemDestroy: function(record) {
        var viewportView = this.application.getController('Viewport').getView('Viewport'),
            stageControlsView = viewportView.getStageControlsView();

        stageControlsView.updateControlsStatus('destroy', record.get('name'));
    },

    /**
     * Event handler Triggered by visualHUD.Models.ClientSettings
     * Used to update status of the particular HUD Item
     * @param model
     * @param options
     */
    updateHUDItemStatus: function(model, event) {
        var changes = event.changes;
        var HUDItemsCollection = this.getCollection('HUDItems');

        _.each(changes, function(set, field) {
            var value = model.get(field),
                namePattern;

            switch(field) {
                case 'statusHealth': {
                    namePattern = /healthIndicator|healthBar/
                    break;
                }
                case 'statusArmor': {
                    namePattern = /armorIndicator|armorBar/
                    break;
                }
                case 'statusAmmo': {
                    namePattern = /ammoIndicator/
                    break;
                }
                case 'statusAccuracy': {
                    namePattern = /accuracyIndicator/
                    break;
                }
                case 'statusSkill': {
                    namePattern = /skillIndicator/
                    break;
                }
            }

            HUDItemsCollection.each(function(record){
                var name = record.get('name');

                if(namePattern && namePattern.test(name)) {
                    record.set('text', value);
                }
            });
        }, this);
    },

    /**
     * Align items action delegated to the visualHUD.Libs.layersManager
     * Triggered by different buttons
     * @param value
     */
    alignItems: function(value){
        var canvasView = this.application.getController('Viewport').getView('Canvas');
        visualHUD.Libs.layersManager.alignEdges(canvasView, value);

        _.each(canvasView.getSelection(), function(view) {
            view.refreshCoordinates();
        });
    },

    /**
     * Arrange items action delegated to the visualHUD.Libs.layersManager
     * Triggered by different buttons
     * @param value
     */
    arrangeItems: function(value){
        var canvasView = this.application.getController('Viewport').getView('Canvas');
        visualHUD.Libs.layersManager.arrangeLayers(canvasView, value);
        canvasView.updateIndexes();
        this.getCollection('HUDItems').sort();
    },
    /**
     * Triggered by TopBar view when HUD action buttons are clicked
     * @param {String} action The name of the action being triggered
     */
    groupActions: function(action){
        switch(action) {
            case 'deleteSelected': {
                this.deleteSelectedItems();
                break;
            }
            case 'groupSelected': {
                this.groupSelectedItems();
                break;
            }
            case 'cloneSelected': {
                this.cloneSelectedItems();
                break;
            }
            case 'undoUpdate': {
                this.application.getController('HistoryManager').undo();
                break;
            }
        }
    },
    /**
     * Function to select all HUD items
     * @param event
     */
    selectAllHUDItems: function(event) {
        var canvas = this.application.getController('Viewport').getView('Canvas');
        canvas.selectAll();
    },

    /**
     * Event triggered by KeyboardManager controller when pressing DEL button
     */
    deleteSelectedItems: function() {
        var canvas = this.application.getController('Viewport').getView('Canvas'),
            selection = canvas.getSelection();

        _.each(selection, function(view) {
            view.model.destroy();
        });

        canvas.deselect();
    },

    /**
     * Event triggered by KeyboardManager controller when pressing arrow buttons
     * @param direction
     * @param offset
     */
    moveSelectedItems: function(direction, offset) {
        var canvas = this.application.getController('Viewport').getView('Canvas'),
            selection = canvas.getSelection();

        _.each(selection, function(view) {
            view.move(direction, offset);
        });
    },

    /**
     * Function to clone group/ungroup selected items
     * @param event
     */
    groupSelectedItems: function() {
        var canvas = this.application.getController('Viewport').getView('Canvas'),
            selection = canvas.getSelection(),
            masterElement = selection[0];
            isUngroup = false,
            groupGuid = null;

        _.each(selection, function(view) {
            if(view.getGroup()) {
                isUngroup = true;
            }
            else {
                groupGuid = groupGuid || visualHUD.Libs.utility.getGuid();
            }
            view.setGroup(groupGuid);
        });

        if(isUngroup == true) {
            canvas.deselect();
            canvas.select(masterElement);
        }
    },

    /**
     * Function to clone selected items
     * @param event
     */
    cloneSelectedItems: function(event) {
        var canvasView = this.application.getController('Viewport').getView('Canvas'),
            selection = Array.prototype.slice.call(canvasView.getSelection()),
            HUDItemModelClass = this.getModelConstructor('HUDItem');

        canvasView.deselect();

        _.each(selection, function(view) {
            var cloneData = view.model.toJSON();

            _.extend(cloneData, {
                group: null,
                coordinates: {
                    top: cloneData.coordinates.top + 10,
                    left: cloneData.coordinates.left + 10
                }
            });

            var newRecord = new HUDItemModelClass(cloneData),
                newItem = this.createNewHUDItem(newRecord);

            this.getCollection('HUDItems').add(newRecord, {silent: true});

            canvasView.select(newItem, true);
        }, this);
    },

    /**
     * Triggered by visualHUD.Views.LoadWindow when new HUD preset is being loaded
     * @param data
     */
    loadHUD: function(data) {
        this.selectAllHUDItems();
        this.deleteSelectedItems();

        this.getCollection('HUDItems').load(data);
    },

    /**
     * Triggered by visualHUD.Views.ImportImageWindow when new image is being uploaded
     * @param src
     */
    importImage: function(src) {
        var clientSettingsModel = this.getModel('ClientSettings');
        clientSettingsModel.set({
            'customBackground': src,
            'canvasShot': 3
        });
        this.application.getController('Viewport').getView('CanvasToolbar').setClientSettings({
            'canvasShot': 3
        });
    }
});

